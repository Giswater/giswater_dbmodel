/*
This file is part of Giswater 3
The program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.
This version of Giswater is provided by Giswater Association
*/


--FUNCTION CODE: 3368

CREATE OR REPLACE FUNCTION SCHEMA_NAME.gw_trg_exploitation()
  RETURNS trigger AS
$BODY$

DECLARE 
v_expl_x_user boolean;
	
BEGIN

    EXECUTE 'SET search_path TO '||quote_literal(TG_TABLE_SCHEMA)||', public';

	-- getting values from system
	v_expl_x_user = (SELECT value FROM config_param_system WHERE parameter = 'admin_exploitation_x_user');

	IF v_expl_x_user IS FALSE THEN

		IF TG_OP = 'INSERT' THEN
	
			IF NEW.active IS TRUE THEN
				
				-- for all users
				INSERT INTO config_user_x_expl SELECT distinct ON (username) NEW.expl_id, username 
				from config_user_x_expl ON CONFLICT (expl_id, username) DO NOTHING;
		
				-- for this user (in case of does not exists)
				INSERT INTO config_user_x_expl VALUES (NEW.expl_id, current_user) 
				ON CONFLICT (expl_id, username) DO NOTHING;

			END IF;

			RETURN NEW;

		ELSIF TG_OP = 'UPDATE' THEN

			IF NEW.active IS TRUE THEN
			
				-- for this user (in case not exists)
				INSERT INTO config_user_x_expl VALUES (NEW.expl_id, current_user) 
				ON CONFLICT (expl_id, username) DO NOTHING;

			ELSE 
				-- delete from config_user_x_expl
				DELETE FROM config_user_x_expl WHERE expl_id = NEW.expl_id;

			END IF;

			RETURN NEW;

		ELSIF TG_OP = 'DELETE' THEN

			-- delete from config_user_x_expl
			DELETE FROM config_user_x_expl WHERE expl_id = NEW.expl_id;

			RETURN OLD;

		END IF;
	
	END IF;
		

END;
$BODY$
  LANGUAGE plpgsql VOLATILE
  COST 100;