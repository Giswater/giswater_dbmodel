/*
This file is part of Giswater
The program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.
This version of Giswater is provided by Giswater Association
*/
BEGIN;

-- Suppress NOTICE messages
SET client_min_messages TO WARNING;

SET search_path = "SCHEMA_NAME", public, pg_catalog;

SELECT plan(12);
-- IMPORTANT: In this test, we check for existence using the code, not the ID,
-- because we don't allow the user to change the code.
-- In test_arc.sql, we test the `arc` table and can check `arc_id`,
-- but here we are testing the views.

-- arc -> pipe
-- initial data is prepared before proceeding with the test
INSERT INTO ve_node_air_valve
(node_id, code, top_elev, custom_top_elev, "depth", node_type, sys_type, nodecat_id, cat_matcat_id, cat_pnom, cat_dnom, cat_dint, epa_type, state, state_type, expl_id, macroexpl_id, sector_id, presszone_id, presszone_type, presszone_head, dma_id, dma_type, macrodma_id, dqa_id, dqa_type, macrodqa_id, arc_id, parent_id, annotation, observ, "comment", staticpressure, soilcat_id, function_type, category_type, fluid_type, location_type, workcat_id, workcat_id_end, workcat_id_plan, builtdate, enddate, ownercat_id, muni_id, postcode, district_id, streetname, postnumber, postcomplement, streetname2, postnumber2, postcomplement2, region_id, province_id, descript, svg, rotation, link, verified, undelete, "label", label_x, label_y, label_rotation, publish, inventory, hemisphere, num_value, adate, adescript, accessibility, dma_style, presszone_style, asset_id, om_state, conserv_state, access_type, placement_type, expl_id2, is_operative, brand_id, model_id, serial_number, minsector_id, macrominsector_id, demand_max, demand_min, demand_avg, press_max, press_min, press_avg, head_max, head_min, head_avg, quality_max, quality_min, quality_avg, created_at, created_by, updated_at, updated_by, the_geom, inp_type, closed, broken, buried, irrigation_indicator, pression_entry, pression_exit, depth_valveshaft, regulator_situation, regulator_location, regulator_observ, lin_meters, exit_type, exit_code, drive_type, cat_valve2, ordinarystatus, shutter, brand2, model2, valve_type, to_arc, airvalve_param_1, airvalve_param_2, connection_type)
VALUES('-902', '-902', 32.8100, NULL, NULL, 'AIR_VALVE', 'VALVE', 'AIR VALVE DN50', 'FD', '16', '50', NULL, 'UNDEFINED', 1, 2, 2, 1, 5, '3', NULL, NULL, 3, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 'soil1', NULL, NULL, NULL, NULL, 'work1', NULL, NULL, '2024-08-22', NULL, 'owner1', 2, NULL, 1, NULL, NULL, NULL, NULL, NULL, NULL, 1, 1, NULL, NULL, NULL, '', '1', NULL, NULL, NULL, NULL, NULL, true, true, NULL, NULL, NULL, NULL, NULL, '204,235,197', '204,235,197', NULL, NULL, NULL, NULL, NULL, NULL, true, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, '2024-08-22 17:00:13.000', 'postgres', '2024-08-22 17:00:13.000', 'postgres', 'SRID=25831;POINT (418474.19510507485 4577983.667174499)'::public.geometry, NULL, false, false, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 0);
INSERT INTO ve_node_air_valve
(node_id, code, top_elev, custom_top_elev, "depth", node_type, sys_type, nodecat_id, cat_matcat_id, cat_pnom, cat_dnom, cat_dint, epa_type, state, state_type, expl_id, macroexpl_id, sector_id, presszone_id, presszone_type, presszone_head, dma_id, dma_type, macrodma_id, dqa_id, dqa_type, macrodqa_id, arc_id, parent_id, annotation, observ, "comment", staticpressure, soilcat_id, function_type, category_type, fluid_type, location_type, workcat_id, workcat_id_end, workcat_id_plan, builtdate, enddate, ownercat_id, muni_id, postcode, district_id, streetname, postnumber, postcomplement, streetname2, postnumber2, postcomplement2, region_id, province_id, descript, svg, rotation, link, verified, undelete, "label", label_x, label_y, label_rotation, publish, inventory, hemisphere, num_value, adate, adescript, accessibility, dma_style, presszone_style, asset_id, om_state, conserv_state, access_type, placement_type, expl_id2, is_operative, brand_id, model_id, serial_number, minsector_id, macrominsector_id, demand_max, demand_min, demand_avg, press_max, press_min, press_avg, head_max, head_min, head_avg, quality_max, quality_min, quality_avg, created_at, created_by, updated_at, updated_by, the_geom, inp_type, closed, broken, buried, irrigation_indicator, pression_entry, pression_exit, depth_valveshaft, regulator_situation, regulator_location, regulator_observ, lin_meters, exit_type, exit_code, drive_type, cat_valve2, ordinarystatus, shutter, brand2, model2, valve_type, to_arc, airvalve_param_1, airvalve_param_2, connection_type)
VALUES('-901', '-901', 32.8100, NULL, NULL, 'AIR_VALVE', 'VALVE', 'AIR VALVE DN50', 'FD', '16', '50', NULL, 'UNDEFINED', 1, 2, 2, 1, 5, '3', NULL, NULL, 3, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 'soil1', NULL, NULL, NULL, NULL, 'work1', NULL, NULL, '2024-08-22', NULL, 'owner1', 2, NULL, 1, NULL, NULL, NULL, NULL, NULL, NULL, 1, 1, NULL, NULL, NULL, '', '1', NULL, NULL, NULL, NULL, NULL, true, true, NULL, NULL, NULL, NULL, NULL, '204,235,197', '204,235,197', NULL, NULL, NULL, NULL, NULL, NULL, true, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, '2024-08-22 17:00:02.000', 'postgres', '2024-08-22 17:00:02.000', 'postgres', 'SRID=25831;POINT (418473.00472849904 4577983.379842222)'::public.geometry, NULL, false, false, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 0);

INSERT INTO ve_arc_pipe
(arc_id, code, node_1, nodetype_1, elevation1, depth1, staticpress1, node_2, nodetype_2, staticpress2, elevation2, depth2, "depth", arccat_id, arc_type, sys_type, cat_matcat_id, cat_pnom, cat_dnom, cat_dint, epa_type, state, state_type, expl_id, macroexpl_id, sector_id, presszone_id, presszone_type, presszone_head, dma_id, dma_type, macrodma_id, dqa_id, dqa_type, macrodqa_id, annotation, observ, "comment", gis_length, custom_length, soilcat_id, function_type, category_type, fluid_type, location_type, workcat_id, workcat_id_end, workcat_id_plan, builtdate, enddate, ownercat_id, muni_id, postcode, district_id, streetname, postnumber, postcomplement, streetname2, postnumber2, postcomplement2, region_id, province_id, descript, link, verified, undelete, "label", label_x, label_y, label_rotation, publish, inventory, num_value, adate, adescript, dma_style, presszone_style, asset_id, pavcat_id, om_state, conserv_state, parent_id, expl_id2, is_operative, brand_id, model_id, serial_number, minsector_id, macrominsector_id, flow_max, flow_min, flow_avg, vel_max, vel_min, vel_avg, created_at, created_by, updated_at, updated_by, the_geom, inp_type, pipe_param_1)
VALUES('-901', '-901', '-902', 'AIR_VALVE', 32.8100, NULL, NULL, '-901', 'AIR_VALVE', NULL, 32.8100, NULL, NULL, 'PVC63-PN10', 'PIPE', 'PIPE', 'PVC', '10', '63', 56.70000, 'PIPE', 1, 2, 2, 1, 5, 3, NULL, NULL, 3, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 1.22, NULL, 'soil1', NULL, NULL, NULL, NULL, 'work1', NULL, NULL, '2024-08-22', NULL, 'owner1', 2, NULL, 1, NULL, NULL, NULL, NULL, NULL, NULL, 1, 1, NULL, '', '1', NULL, NULL, NULL, NULL, NULL, true, true, NULL, NULL, NULL, '204,235,197', '204,235,197', NULL, 'Asphalt', NULL, NULL, NULL, NULL, true, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, '2024-08-22 17:05:32.000', 'postgres', '2024-08-22 17:05:32.000', 'postgres', 'SRID=25831;LINESTRING (418473.00472849904 4577983.379842222, 418474.19510507485 4577983.667174499)'::public.geometry, 'PIPE', NULL);
SELECT is((SELECT count(*)::integer FROM ve_arc_pipe WHERE code = '-901'), 1, 'INSERT: ve_arc_pipe "-901" was inserted');
SELECT is((SELECT count(*)::integer FROM arc WHERE code = '-901'), 1, 'INSERT: arc:pipe "-901" was inserted');

UPDATE ve_arc_pipe SET custom_length = 1.0000 WHERE code = '-901';
SELECT is((SELECT custom_length FROM ve_arc_pipe WHERE code = '-901'), 1.0000, 'UPDATE: ve_arc_pipe "-901" was updated');
SELECT is((SELECT custom_length FROM arc WHERE code = '-901'), 1.0000, 'UPDATE: arc:pipe "-901" was updated');

DELETE FROM ve_arc_pipe WHERE code = '-901';
SELECT is((SELECT count(*)::integer FROM ve_arc_pipe WHERE code = '-901'), 0, 'DELETE: ve_arc_pipe "-901" was deleted');
SELECT is((SELECT count(*)::integer FROM arc WHERE code = '-901'), 0, 'DELETE: arc:pipe "-901" was deleted');

-- arc -> varc
-- initial data is prepared before proceeding with the test
INSERT INTO ve_node_check_valve
(node_id, code, top_elev, custom_top_elev, "depth", node_type, sys_type, nodecat_id, cat_matcat_id, cat_pnom, cat_dnom, cat_dint, epa_type, state, state_type, expl_id, macroexpl_id, sector_id, macrosector_id, sector_type, presszone_id, presszone_type, presszone_head, dma_id, dma_type, macrodma_id, dqa_id, dqa_type, macrodqa_id, supplyzone_id, supplyzone_type, arc_id, parent_id, annotation, observ, "comment", staticpressure, soilcat_id, function_type, category_type, fluid_type, location_type, workcat_id, workcat_id_end, workcat_id_plan, builtdate, enddate, ownercat_id, muni_id, postcode, district_id, streetname, postnumber, postcomplement, streetname2, postnumber2, postcomplement2, region_id, province_id, descript, svg, rotation, link, verified, undelete, "label", label_x, label_y, label_rotation, label_quadrant, publish, inventory, hemisphere, num_value, adate, adescript, accessibility, sector_style, dma_style, presszone_style, dqa_style, supplyzone_style, asset_id, om_state, conserv_state, access_type, placement_type, expl_id2, is_operative, brand_id, model_id, serial_number, minsector_id, macrominsector_id, demand_max, demand_min, demand_avg, press_max, press_min, press_avg, head_max, head_min, head_avg, quality_max, quality_min, quality_avg, created_at, created_by, updated_at, updated_by, the_geom, inp_type, closed, broken, buried, irrigation_indicator, pression_entry, pression_exit, depth_valveshaft, regulator_situation, regulator_location, regulator_observ, lin_meters, exit_type, exit_code, drive_type, cat_valve2, ordinarystatus, shutter, brand2, model2, valve_type, to_arc, checkvalve_param_1, checkvalve_param_2, connection_type)
VALUES('-904', '-904', 23.2100, NULL, 0.0000, 'CHECK_VALVE', 'VALVE', 'CHK-VALVE100-PN16', 'FD', '16', '100', 102.00000, 'SHORTPIPE', 1, 2, 1, 1, 3, 1, 'DISTRIBUTION', 3, NULL, 71.75, 2, NULL, NULL, 1, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 0.000, 'soil1', 'St. Function', 'St. Category', 'St. Fluid', 'St. Location', 'work2', NULL, NULL, '2014-03-06', NULL, 'owner1', 1, '08830', 1, NULL, NULL, NULL, NULL, NULL, NULL, 1, 1, NULL, NULL, NULL, 'https://www.giswater.org', 0, NULL, NULL, NULL, NULL, NULL, NULL, NULL, true, NULL, NULL, NULL, NULL, NULL, '204,235,197', '179,205,227', '204,235,197', '251,181,174', NULL, NULL, NULL, NULL, NULL, NULL, NULL, true, NULL, NULL, NULL, NULL, 0, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, '2020-08-13 09:15:52.000', 'postgres', '2024-02-21 12:08:24.000', 'postgres', 'SRID=25831;POINT (418473.1278709034 4577982.640987795)'::public.geometry, 'SHORTPIPE', false, false, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 0);

INSERT INTO ve_node_check_valve
(node_id, code, top_elev, custom_top_elev, "depth", node_type, sys_type, nodecat_id, cat_matcat_id, cat_pnom, cat_dnom, cat_dint, epa_type, state, state_type, expl_id, macroexpl_id, sector_id, macrosector_id, sector_type, presszone_id, presszone_type, presszone_head, dma_id, dma_type, macrodma_id, dqa_id, dqa_type, macrodqa_id, supplyzone_id, supplyzone_type, arc_id, parent_id, annotation, observ, "comment", staticpressure, soilcat_id, function_type, category_type, fluid_type, location_type, workcat_id, workcat_id_end, workcat_id_plan, builtdate, enddate, ownercat_id, muni_id, postcode, district_id, streetname, postnumber, postcomplement, streetname2, postnumber2, postcomplement2, region_id, province_id, descript, svg, rotation, link, verified, undelete, "label", label_x, label_y, label_rotation, label_quadrant, publish, inventory, hemisphere, num_value, adate, adescript, accessibility, sector_style, dma_style, presszone_style, dqa_style, supplyzone_style, asset_id, om_state, conserv_state, access_type, placement_type, expl_id2, is_operative, brand_id, model_id, serial_number, minsector_id, macrominsector_id, demand_max, demand_min, demand_avg, press_max, press_min, press_avg, head_max, head_min, head_avg, quality_max, quality_min, quality_avg, created_at, created_by, updated_at, updated_by, the_geom, inp_type, closed, broken, buried, irrigation_indicator, pression_entry, pression_exit, depth_valveshaft, regulator_situation, regulator_location, regulator_observ, lin_meters, exit_type, exit_code, drive_type, cat_valve2, ordinarystatus, shutter, brand2, model2, valve_type, to_arc, checkvalve_param_1, checkvalve_param_2, connection_type)
VALUES('-904', '-904', 23.2100, NULL, 0.0000, 'CHECK_VALVE', 'VALVE', 'CHK-VALVE100-PN16', 'FD', '16', '100', 102.00000, 'SHORTPIPE', 1, 2, 1, 1, 3, 1, 'DISTRIBUTION', 3, NULL, 71.75, 2, NULL, NULL, 1, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 0.000, 'soil1', 'St. Function', 'St. Category', 'St. Fluid', 'St. Location', 'work2', NULL, NULL, '2014-03-06', NULL, 'owner1', 1, '08830', 1, NULL, NULL, NULL, NULL, NULL, NULL, 1, 1, NULL, NULL, NULL, 'https://www.giswater.org', 0, NULL, NULL, NULL, NULL, NULL, NULL, NULL, true, NULL, NULL, NULL, NULL, NULL, '204,235,197', '179,205,227', '204,235,197', '251,181,174', NULL, NULL, NULL, NULL, NULL, NULL, NULL, true, NULL, NULL, NULL, NULL, 0, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, '2020-08-13 09:15:52.000', 'postgres', '2024-02-21 12:08:24.000', 'postgres', 'SRID=25831;POINT (418474.44138988364 4577982.928320073)'::public.geometry, 'SHORTPIPE', false, false, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 0);

INSERT INTO ve_arc_varc
(arc_id, code, node_1, nodetype_1, elevation1, depth1, staticpress1, node_2, nodetype_2, staticpress2, elevation2, depth2, "depth", arccat_id, arc_type, sys_type, cat_matcat_id, cat_pnom, cat_dnom, cat_dint, epa_type, state, state_type, expl_id, macroexpl_id, sector_id, macrosector_id, sector_type, presszone_id, presszone_type, presszone_head, dma_id, dma_type, macrodma_id, dqa_id, dqa_type, macrodqa_id, supplyzone_id, supplyzone_type, annotation, observ, "comment", gis_length, custom_length, soilcat_id, function_type, category_type, fluid_type, location_type, workcat_id, workcat_id_end, workcat_id_plan, builtdate, enddate, ownercat_id, muni_id, postcode, district_id, streetname, postnumber, postcomplement, streetname2, postnumber2, postcomplement2, region_id, province_id, descript, link, verified, undelete, "label", label_x, label_y, label_rotation, label_quadrant, publish, inventory, num_value, adate, adescript, sector_style, dma_style, presszone_style, dqa_style, supplyzone_style, asset_id, pavcat_id, om_state, conserv_state, parent_id, expl_id2, is_operative, brand_id, model_id, serial_number, minsector_id, macrominsector_id, flow_max, flow_min, flow_avg, vel_max, vel_min, vel_avg, created_at, created_by, updated_at, updated_by, the_geom, inp_type)
VALUES('-902', '-902', '-903', 'CHECK_VALVE', 32.8100, NULL, NULL, '-904', 'CHECK_VALVE', 3.500, 81.5000, 0.0000, 0.00, 'VIRTUAL', 'VARC', 'VARC', 'PE-HD', NULL, NULL, 999.00000, 'PIPE', 1, 2, 2, 1, 4, 2, 'SOURCE', 5, NULL, 119.69, 5, NULL, NULL, 4, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 10.05, NULL, 'soil1', 'St. Function', 'St. Category', 'St. Fluid', 'St. Location', 'work3', NULL, NULL, '2016-02-19', NULL, 'owner1', 2, '08830', 2, NULL, NULL, NULL, NULL, NULL, NULL, 1, 1, NULL, 'https://www.giswater.org', 0, NULL, NULL, NULL, NULL, NULL, NULL, NULL, true, NULL, NULL, NULL, '222,203,228', '255,255,204', '254,217,166', '222,203,228', NULL, NULL, 'Asphalt', NULL, NULL, NULL, NULL, true, NULL, NULL, NULL, NULL, 0, NULL, NULL, NULL, NULL, NULL, NULL, '2020-08-13 09:15:52.000', 'postgres', '2024-02-21 12:08:24.000', 'postgres', 'SRID=25831;LINESTRING (418473.1278709034 4577982.640987795, 418474.44138988364 4577982.928320073)'::public.geometry, 'PIPE');

SELECT is((SELECT count(*)::integer FROM ve_arc_varc WHERE code = '-902'), 1, 'INSERT: ve_arc_varc "-902" was inserted');
SELECT is((SELECT count(*)::integer FROM arc WHERE code = '-902'), 1, 'INSERT: arc:varc "-902" was inserted');

UPDATE ve_arc_varc SET custom_length = 1.0000 WHERE code = '-902';
SELECT is((SELECT custom_length FROM ve_arc_varc WHERE code = '-902'), 1.0000, 'UPDATE: ve_arc_varc "-902" was updated');
SELECT is((SELECT custom_length FROM arc WHERE code = '-902'), 1.0000, 'UPDATE: arc:varc "-902" was updated');

DELETE FROM ve_arc_varc WHERE code = '-902';
SELECT is((SELECT count(*)::integer FROM ve_arc_varc WHERE code = '-902'), 0, 'DELETE: ve_arc_varc "-902" was deleted');
SELECT is((SELECT count(*)::integer FROM arc WHERE code = '-902'), 0, 'DELETE: arc:varc "-902" was deleted');


SELECT * FROM finish();

ROLLBACK;
